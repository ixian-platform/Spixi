<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Restore Account</title>
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <!--    TODO: change later-->
    <link rel="stylesheet" type="text/css" href="css/*SL{SpixiThemeMode}">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="libs/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="libs/fontawesome/css/solid.min.css">
</head>
<body>
<div id="wrap" class="onboarding-container">
    <section class="onboarding-section restore" id="onboardingSection">
        <div class="onboarding-stepper-header label-lg s-text-02 typing">
            <span class="back" id="stepperBack" onclick="prevStep()">*SL{onboarding-step-back}</span>
        </div>
        <img src="" data-theme-src="img/spixi-logo-full.svg" alt="spixi logo full"/>
        <div id="step1" class="single-step create-step active">
            <span class="label-lg">*SL{intro-restore-title}</span>
            <div class="body-md">*SL{intro-restore-subtitle}</div>
            <div id="selectBackupButton" onclick="onSelectBackupFile()" class="spixi-flat-button outline label-sm"
                 style="width: 100%;margin: 24px 0;">
                <i class="fa fa-file-arrow-up"></i> *SL{intro-restore-select-file}
            </div>
            <div id="selectedFileContainer" class="upload-file-container" style="display: none">
                <div class="body-md"><i class="fa fa-check s-text-success"></i> <span id="selectedFilenameSpan">file</span></div>
                <i onclick="removeSelectedFile()" class="fa fa-times body-md"></i>
            </div>
            <img src="" data-theme-src="img/restore-account/restore-1.svg" alt="restore-1"/>
        </div>
        <div id="step2" class="single-step create-step restore-step-2">
            <span class="label-lg">*SL{intro-restore-pass-title}</span>
            <div class="body-md">*SL{intro-restore-pass-subtitle}</div>
            <div class="password-inputs restore">
                <div class="pass-input-wrapper">
                    <input id="restorePassword" autofocus maxlength="256" oninput="onPassInput()" type="password"
                           class="create-account-username body-sm"
                           placeholder="*SL{intro-restore-pass-placeholder}"/>
                    <i class="fa fa-eye password-eye" onclick="togglePasswordVisible('restorePassword', this)"></i>
                </div>
                <span class="label-xs s-text-error" id="passwordError" style="display: none">*SL{intro-restore-pass-error}</span>
            </div>
            <img src="" data-theme-src="img/restore-account/restore-2.svg" alt="restore-2"/>
            <div class="create-password-note">
                <span class="label-sm s-text-01">*SL{intro-restore-note-title}</span>
                <span class="body-sm s-text-01">*SL{intro-restore-note-subtitle}</span>
            </div>
        </div>
        <div class="onboarding-stepper-footer">
            <div id="stepperNext" onclick="nextStep()" class="spixi-flat-button label-sm" style="width: 100%">
                *SL{onboarding-step-next} <i
                    class="fa fa-arrow-right"></i></div>
            <div id="restoreAccount" onclick="onRestoreAccount()" class="spixi-flat-button label-sm"
                 style="width: 100%;display: none">
                *SL{intro-restore-button} <i
                    class="fa fa-arrow-right"></i></div>
        </div>
    </section>

    <section class="create-account-start-section" id="restoringAccount" style="display: none">
        <div class="loading-modal-container">
            <img src="" data-theme-src="img/spixi-logo-full.svg" alt="spixi logo full" style="margin-bottom: 64px;"/>
            <span class="spixi-loader loader-create-acc"></span>
            <div class="new-modal-texts">
                <span class="label-lg">*SL{intro-restoring-title}</span>
                <span class="body-sm">*SL{intro-restoring-subtitle}</span>
            </div>
        </div>
    </section>
</div>

<script src="js/spixi.js"></script>
<script type="text/javascript">
    // Function to apply the theme on data-theme-src images
    applyThemeOnDataThemeSrcImages();

    let selectedFile = null;
    const steps = Array.from(document.querySelectorAll('.single-step'));
    let currentStep = 1;
    let password = "";

    if (!selectedFile) {
        document.getElementById("stepperNext").classList.add('disabled');
    }

    function toggleStep() {
        steps.forEach(el => el.classList.remove('active'));
        document.getElementById(`step${currentStep}`).classList.add('active');
        if (currentStep === steps.length) {
            document.getElementById("stepperNext").style.display = "none";
            document.getElementById("restoreAccount").style.display = "flex";
            if (document.getElementById("restorePassword").value < 10) {
                document.getElementById("restoreAccount").classList.add('disabled');
            } else {
                document.getElementById("restoreAccount").classList.remove('disabled');
            }
        } else {
            document.getElementById("stepperNext").style.display = "flex";
            document.getElementById("restoreAccount").style.display = "none";
        }
    }

    function nextStep() {
        if (currentStep < steps.length) {
            currentStep++;
            toggleStep()
        }
    }

    function prevStep() {
        if (currentStep === 1) {
            location.href = "ixian:back";
        } else if (currentStep > 1) {
            currentStep--;
            toggleStep()
        }
    }

    function onSelectBackupFile() {
        location.href = "ixian:selectfile";
    }

    function onRestoreAccount() {
        if (password) {
            location.href = "ixian:restore:" + password;
            // document.getElementById("restoringAccount").style.display = "flex";
            // document.getElementById("onboardingSection").style.display = "none";
        }
    }


    function setUploadedFileName(fileName) {
        //TODO: check if this works on all platforms
        const normalized = fileName.replace(/\\/g, "/");
        selectedFile = normalized.split("/").pop();
        document.getElementById("selectBackupButton").style.display = "none";
        document.getElementById("selectedFileContainer").style.display = "flex";
        document.getElementById("selectedFilenameSpan").innerText = selectedFile;
        document.getElementById("stepperNext").classList.remove("disabled");
    }


    function removeLoadingOverlay() {
        document.getElementById("restoringAccount").style.display = "none";
    }

    function togglePasswordVisible(inputId, node) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === 'password';

        input.type = isPassword ? 'text' : 'password';

        node.classList.remove('fa-eye', 'fa-eye-slash');
        node.classList.add(isPassword ? 'fa-eye-slash' : 'fa-eye');
    }

    function onPassInput() {
        const passwordElement = document.getElementById("restorePassword");
        password = passwordElement.value.trim();

        if (passwordElement.value.length < 10) {
            document.getElementById("restoreAccount").classList.add('disabled');
        } else {
            document.getElementById("restoreAccount").classList.remove('disabled');
        }
    }

    function removeSelectedFile() {
        selectedFile = null;
        document.getElementById("selectBackupButton").style.display = "flex";
        document.getElementById("selectedFileContainer").style.display = "none";
    }

    function showPasswordError(){
        document.getElementById("passwordError").style.display = "block";
        document.getElementById("restorePassword").classList.add("error");
    }
</script>
</body>
</html>